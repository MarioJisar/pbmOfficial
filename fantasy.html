<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PBM Fantasy</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/ventas.css">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
</head>

<body>
  <!-- Eliminado bloque de registro y duplicado de Firebase. Toda la l√≥gica la gestiona js/fantasy.js -->

  <header>
    <h1>PBM Fantasy</h1>
    <div class="header-buttons">
      <button id="ir-index-btn" class="header-button-left">Inicio</button>
      <button id="eliminar-usuario-btn" class="header-button-right header-button-danger">Eliminar usuario</button>
      <button id="logout-btn" class="header-button-right">Cerrar sesi√≥n</button>
    </div>
  </header>
  <main>
    <div id="confirmacion-eliminar" class="confirmacion-eliminar" style="display:none;">
      <p>¬øSeguro que quieres eliminar tu usuario y todos tus datos? Esta acci√≥n es irreversible.</p>
      <div class="modal-botones">
        <button id="confirmar-eliminar-btn" class="boton-confirmar">S√≠, eliminar</button>
        <button id="cancelar-eliminar-btn">Cancelar</button>
      </div>
    </div>
    <section id="bienvenida" style="display:none;">
      <h2>¬°Bienvenido, <span id="nombre-usuario"></span>!</h2>
      <p>Crea tu plantilla fantasy solo con jugadores de PBM.</p>
      
      <!-- Info de temporada y jornada -->
      <div id="info-temporada" class="info-temporada">
        <div class="info-bloque temporada-actual">
          <h3>Temporada <span id="numero-temporada">-</span></h3>
          <p class="estado">Estado: <span id="estado-temporada">-</span></p>
        </div>
        
        <div class="info-bloque jornada-actual">
          <h3>Jornada <span id="numero-jornada">-</span> de <span id="total-jornadas">-</span></h3>
          <p class="tiempo">Pr√≥ximo mercado: <span id="proximo-mercado">-</span></p>
        </div>
        
        <div class="info-bloque historial-puntos">
          <h3>Mis Puntos</h3>
          <p>Esta jornada: <span id="puntos-jornada">-</span></p>
          <p>Total temporada: <span id="puntos-temporada">-</span></p>
        </div>
      </div>
      
      <!-- Tabla de mejores puntuaciones -->
      <div id="tabla-puntuaciones" class="tabla-puntuaciones" style="display:none;">
        <h3>Mejores Puntuaciones</h3>
        <table>
          <thead>
            <tr>
              <th>Pos</th>
              <th>Usuario</th>
              <th>Puntos</th>
              <th>Mejor Alineaci√≥n</th>
            </tr>
          </thead>
          <tbody id="tbody-puntuaciones">
            <!-- Se llena din√°micamente -->
          </tbody>
        </table>
      </div>
    </section>
    <section id="login-requerido" style="display:none;">
      <p>Debes iniciar sesi√≥n para jugar al Fantasy. <a href="login.html">Inicia sesi√≥n aqu√≠</a></p>
    </section>
    <section id="fantasy-section" style="display:none;">
      <h2>Tu plantilla</h2>
      <div id="presupuesto-section" class="presupuesto-info">
        <b>Presupuesto disponible:</b> <span id="presupuesto-usuario">0</span>
      </div>
      <form id="plantilla-form">
        <div id="jugadores-lista" class="cartas-jugadores"></div>
        <button type="submit">Actualizar jugadores</button>
      </form>
      <div id="alineacion-section" class="fantasy-section" style="display:none;">
        <div class="leyenda-titulo">
          <h3>Coloca tu plantilla en el campo</h3>
          <span class="info-icon" title="Informaci√≥n sobre la plantilla">‚ìò</span>
        </div>

        <div class="leyenda-info">
          <div class="leyenda-grid">
            <div class="leyenda-item">
              <span class="emoji">‚öΩ</span>
              <span class="texto">Goles marcados</span>
            </div>
            <div class="leyenda-item">
              <span class="emoji">üëü</span>
              <span class="texto">Asistencias</span>
            </div>
            <div class="leyenda-item">
              <span class="emoji">üèÜ</span>
              <span class="texto">MVP del partido</span>
            </div>
            <div class="leyenda-item">
              <span class="emoji">üí∞</span>
              <span class="texto">Valor del jugador</span>
            </div>
            <div class="leyenda-item">
              <span class="emoji">üìä</span>
              <span class="texto">Puntos acumulados</span>
            </div>
          </div>
        </div>

        <div id="campo-futbol" class="campo-futbol">
          <div class="campo-layout campo-layout-top">
            <div class="casilla-posicion">
              <div class="zona-drop" data-pos="atacante"></div>
              <div class="pos-label">Atacante</div>
            </div>
          </div>
          <div class="campo-layout campo-layout-bottom">
            <div class="casilla-posicion">
              <div class="zona-drop" data-pos="defensa"></div>
              <div class="pos-label">Defensa</div>
            </div>
            <div class="casilla-posicion">
              <div class="zona-drop" data-pos="medio"></div>
              <div class="pos-label">Medio</div>
            </div>
          </div>
        </div>
        <p id="fantasy-mensaje"></p>
        <div style="margin-top:1em;">
          <h4>Tus jugadores disponibles</h4>
          <div id="jugadores-disponibles" class="cartas-jugadores"></div>
        </div>
        <button id="guardar-alineacion" type="button">Guardar alineaci√≥n</button>
        <p id="alineacion-mensaje"></p>
      </div>

      <!-- Mercado de ventas entre usuarios -->
      <section id="mercado-ventas-section" style="margin-top:2em;">
        <h2>Mercado de Ventas entre Usuarios</h2>
        <div id="mercado-ventas-lista" class="cartas-jugadores"></div>
      </section>

      <!-- Modal para poner jugador en venta -->
      <div id="modal-venta" class="modal-venta">
        <div class="modal-contenido">
          <h3>Poner jugador en venta</h3>
          <p id="modal-jugador-nombre" class="modal-jugador"></p>
          <label for="modal-precio-venta">Precio de venta:</label>
          <input type="number" id="modal-precio-venta" min="1" step="1" class="modal-precio-input">
          <span id="modal-precio-mercado" class="modal-precio-info"></span>
          <div class="modal-botones">
            <button id="modal-confirmar-venta" class="boton-confirmar">Poner en
              venta</button>
            <button id="modal-cancelar-venta">Cancelar</button>
          </div>
        </div>
      </div>

      <section id="mercado-section" style="margin-top:2em;">
        <h2>Mercado de Jugadores</h2>
        <div id="notificaciones-mercado" style="background:#ffe9b3; padding:0.5em; margin-bottom:1em;"></div>
        <div id="mercado-lista" class="cartas-jugadores"></div>
        <h3>Movimientos recientes</h3>
        <ul id="movimientos-mercado"></ul>
      </section>

      <p id="fantasy-mensaje"></p>
      <style>
        .cartas-jugadores {
          display: flex;
          flex-wrap: wrap;
          gap: 1em;
          margin-bottom: 1em;
        }

        .carta-jugador {
          background: #fff;
          border-radius: 10px;
          box-shadow: 0 2px 8px #0002;
          padding: 1em;
          width: 180px;
          min-height: 220px;
          display: flex;
          flex-direction: column;
          align-items: center;
          position: relative;
          cursor: grab;
          user-select: none;
          transition: box-shadow 0.2s;
        }

        .carta-jugador img {
          width: 80px;
          height: 80px;
          border-radius: 50%;
          object-fit: cover;
          margin-bottom: 0.5em;
          background: #eee;
        }

        .carta-jugador .nombre {
          font-weight: bold;
          font-size: 1.1em;
          margin-bottom: 0.2em;
        }

        .carta-jugador .puntos {
          color: #1a7f37;
          font-weight: bold;
          margin-bottom: 0.2em;
        }

        .carta-jugador .coste {
          color: #b8860b;
          margin-bottom: 0.2em;
        }

        .carta-jugador .stats {
          font-size: 0.95em;
          margin-bottom: 0.2em;
        }

        .carta-jugador .acciones {
          margin-top: 0.5em;
        }

        .campo-futbol {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 1em;
          margin-bottom: 1em;
        }

        .zona-drop {
          width: 180px;
          height: 260px;
          border: 2px dashed #1976d2;
          border-radius: 10px;
          background: #e3f2fd;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          color: #1976d2;
          margin: 0.5em;
          transition: background 0.2s;
          position: relative;
        }

        .zona-drop.drag-over {
          background: #bbdefb;
        }

        .carta-jugador.dragging {
          opacity: 0.5;
          border: 2px solid #1976d2;
          box-shadow: 0 0 16px #1976d2;
        }

        .zona-drop .remove-carta {
          position: absolute;
          top: 6px;
          right: 10px;
          background: #b71c1c;
          color: #fff;
          border: none;
          border-radius: 50%;
          width: 24px;
          height: 24px;
          font-size: 1.1em;
          cursor: pointer;
          z-index: 2;
          display: flex;
          align-items: center;
          justify-content: center;
        }
      </style>
    </section>
  </main>
  <!-- Scripts de Firebase y configuraci√≥n -->
  <script type="module" src="js/fantasy.js"></script>
  <script type="module" src="js/ventas.js"></script>
  </script>
  <script type="module">
    import { auth, initializeFirebase } from './firebase/firebase-config.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    // Comprobar si el usuario est√° logueado
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Usuario logueado
        document.getElementById('bienvenida').style.display = '';
        document.getElementById('fantasy-section').style.display = '';
        document.getElementById('login-requerido').style.display = 'none';
        document.getElementById('nombre-usuario').textContent = user.displayName || user.email;
      } else {
        // No logueado
        document.getElementById('bienvenida').style.display = 'none';
        document.getElementById('fantasy-section').style.display = 'none';
        document.getElementById('login-requerido').style.display = '';
      }
    });

    // Logout con Firebase
    document.getElementById('logout-btn').onclick = async () => {
      await signOut(auth);
      window.location.href = 'login.html';
    };

    // Ir al index
    document.getElementById('ir-index-btn').onclick = () => {
      window.location.href = 'index.html';
    };

    // Eliminar usuario con doble confirmaci√≥n
    const eliminarBtn = document.getElementById('eliminar-usuario-btn');
    const confirmacionDiv = document.getElementById('confirmacion-eliminar');
    const confirmarEliminarBtn = document.getElementById('confirmar-eliminar-btn');
    const cancelarEliminarBtn = document.getElementById('cancelar-eliminar-btn');

    eliminarBtn.onclick = () => {
      confirmacionDiv.style.display = 'block';
    };
    cancelarEliminarBtn.onclick = () => {
      confirmacionDiv.style.display = 'none';
    };
    confirmarEliminarBtn.onclick = async () => {
      try {
        // Eliminar datos del usuario en Firestore antes de eliminar la cuenta
        const { getFirestore, doc, getDoc, setDoc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js');
        const db = getFirestore();
        const user = auth.currentUser;
        if (user) {
          // Recuperar plantilla antes de eliminar
          const userDoc = await getDoc(doc(db, 'usuarios', user.uid));
          let plantilla = [];
          if (userDoc.exists()) {
            plantilla = userDoc.data().plantilla || [];
          }
          // Recuperar mercado
          const mercadoDoc = await getDoc(doc(db, 'mercado', 'global'));
          let mercado = {};
          if (mercadoDoc.exists()) {
            mercado = mercadoDoc.data().mercado || {};
          }
          // Devolver jugadores al mercado con valor al 80% y etiqueta
          plantilla.forEach(jugador => {
            mercado[jugador] = null;
            // Guardar info de "devuelto80" en notificaciones del mercado
            // Se marca en Firestore para que fantasy.js lo muestre
            if (!mercado._devueltos) mercado._devueltos = {};
            mercado._devueltos[jugador] = true;
          });
          await setDoc(doc(db, 'mercado', 'global'), { mercado }, { merge: true });
          // Eliminar documento de usuario
          await deleteDoc(doc(db, 'usuarios', user.uid));
        }
        await auth.currentUser.delete();
        window.location.href = 'login.html';
      } catch (e) {
        alert('Debes volver a iniciar sesi√≥n para eliminar tu usuario por seguridad.');
        await signOut(auth);
        window.location.href = 'login.html';
      }
    };
  </script>
  <!-- Cargar Firebase primero -->
  <script type="module" src="firebase/firebase-config.js"></script>
  
  <!-- Cargar scripts de la aplicaci√≥n -->
  <script type="module" src="js/utils.js"></script>
  <script type="module" src="js/fantasy.js"></script>
  <script type="module" src="js/ventas.js"></script>
</body>