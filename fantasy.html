<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PBM Fantasy</title>
  <link rel="stylesheet" href="css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
</head>

<body>
  <!-- Eliminado bloque de registro y duplicado de Firebase. Toda la lógica la gestiona js/fantasy.js -->

  <header>
    <h1>PBM Fantasy</h1>
    <button id="logout-btn" style="float:right;">Cerrar sesión</button>
    <button id="eliminar-usuario-btn" style="float:right; margin-right:1em; background:#b71c1c; color:white;">Eliminar
      usuario</button>
    <button id="ir-index-btn" style="float:left; margin-right:1em; background:#1976d2; color:white;">Inicio</button>
  </header>
  <main>
    <div id="confirmacion-eliminar"
      style="display:none; background:#ffe9b3; padding:1em; border:2px solid #b71c1c; margin:1em 0; text-align:center;">
      <p>¿Seguro que quieres eliminar tu usuario y todos tus datos? Esta acción es irreversible.</p>
      <button id="confirmar-eliminar-btn" style="background:#b71c1c; color:white;">Sí, eliminar</button>
      <button id="cancelar-eliminar-btn">Cancelar</button>
    </div>
    <section id="bienvenida" style="display:none;">
      <h2>¡Bienvenido, <span id="nombre-usuario"></span>!</h2>
      <p>Crea tu plantilla fantasy solo con jugadores de PBM.</p>
    </section>
    <section id="login-requerido" style="display:none;">
      <p>Debes iniciar sesión para jugar al Fantasy. <a href="login.html">Inicia sesión aquí</a></p>
    </section>
    <section id="fantasy-section" style="display:none;">
      <h2>Tu plantilla</h2>
      <div id="presupuesto-section" style="margin-bottom:1em;">
        <b>Presupuesto disponible:</b> <span id="presupuesto-usuario">0</span>
      </div>
      <form id="plantilla-form">
        <div id="jugadores-lista" class="cartas-jugadores"></div>
        <button type="submit">Actualizar jugadores</button>
      </form>
      <div id="alineacion-section" style="display:none; margin-top:2em;">
        <h3>Coloca tu plantilla en el campo</h3>
        <div id="campo-futbol" class="campo-futbol">
          <div style="display:flex; justify-content:center;">
            <div class="casilla-posicion">
              <div class="zona-drop" data-pos="portero"></div>
              <div class="pos-label">Portero</div>
            </div>
          </div>
          <div style="display:flex; gap:1em; justify-content:center; flex-wrap:wrap; margin-top:0.5em;">
            <div class="casilla-posicion">
              <div class="zona-drop" data-pos="defensa1"></div>
              <div class="pos-label">Defensa 1</div>
            </div>
            <div class="casilla-posicion">
              <div class="zona-drop" data-pos="defensa2"></div>
              <div class="pos-label">Defensa 2</div>
            </div>
          </div>
          <div style="display:flex; gap:1em; justify-content:center; flex-wrap:wrap; margin-top:0.5em;">
            <div class="casilla-posicion">
              <div class="zona-drop" data-pos="atacante1"></div>
              <div class="pos-label">Atacante 1</div>
            </div>
            <div class="casilla-posicion">
              <div class="zona-drop" data-pos="atacante2"></div>
              <div class="pos-label">Atacante 2</div>
            </div>
          </div>
        </div>
        <p id="fantasy-mensaje"></p>
        <div style="margin-top:1em;">
          <h4>Tus jugadores disponibles</h4>
          <div id="jugadores-disponibles" class="cartas-jugadores"></div>
        </div>
        <button id="guardar-alineacion" type="button">Guardar alineación</button>
        <p id="alineacion-mensaje"></p>
      </div>

      <!-- Mercado de ventas entre usuarios -->
      <section id="mercado-ventas-section" style="margin-top:2em;">
        <h2>Mercado de Ventas entre Usuarios</h2>
        <div id="mercado-ventas-lista" class="cartas-jugadores"></div>
      </section>

      <!-- Modal para poner jugador en venta -->
      <div id="modal-venta"
        style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#0008; z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:2em; border-radius:10px; min-width:300px; max-width:90vw; margin:auto;">
          <h3>Poner jugador en venta</h3>
          <p id="modal-jugador-nombre" style="font-weight:bold;"></p>
          <label for="modal-precio-venta">Precio de venta:</label>
          <input type="number" id="modal-precio-venta" min="1" step="1" style="width:80px;">
          <span id="modal-precio-mercado" style="margin-left:1em; color:#888;"></span>
          <div style="margin-top:1em;">
            <button id="modal-confirmar-venta" style="background:#1a7f37; color:#fff; margin-right:1em;">Poner en
              venta</button>
            <button id="modal-cancelar-venta">Cancelar</button>
          </div>
        </div>
      </div>

      <section id="mercado-section" style="margin-top:2em;">
        <h2>Mercado de Jugadores</h2>
        <div id="notificaciones-mercado" style="background:#ffe9b3; padding:0.5em; margin-bottom:1em;"></div>
        <div id="mercado-lista" class="cartas-jugadores"></div>
        <h3>Movimientos recientes</h3>
        <ul id="movimientos-mercado"></ul>
      </section>

      <p id="fantasy-mensaje"></p>
      <style>
        .cartas-jugadores {
          display: flex;
          flex-wrap: wrap;
          gap: 1em;
          margin-bottom: 1em;
        }

        .carta-jugador {
          background: #fff;
          border-radius: 10px;
          box-shadow: 0 2px 8px #0002;
          padding: 1em;
          width: 180px;
          min-height: 220px;
          display: flex;
          flex-direction: column;
          align-items: center;
          position: relative;
          cursor: grab;
          user-select: none;
          transition: box-shadow 0.2s;
        }

        .carta-jugador img {
          width: 80px;
          height: 80px;
          border-radius: 50%;
          object-fit: cover;
          margin-bottom: 0.5em;
          background: #eee;
        }

        .carta-jugador .nombre {
          font-weight: bold;
          font-size: 1.1em;
          margin-bottom: 0.2em;
        }

        .carta-jugador .puntos {
          color: #1a7f37;
          font-weight: bold;
          margin-bottom: 0.2em;
        }

        .carta-jugador .coste {
          color: #b8860b;
          margin-bottom: 0.2em;
        }

        .carta-jugador .stats {
          font-size: 0.95em;
          margin-bottom: 0.2em;
        }

        .carta-jugador .acciones {
          margin-top: 0.5em;
        }

        .campo-futbol {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 1em;
          margin-bottom: 1em;
        }

        .zona-drop {
          width: 180px;
          height: 220px;
          border: 2px dashed #1976d2;
          border-radius: 10px;
          background: #e3f2fd;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          color: #1976d2;
          margin: 0.5em;
          transition: background 0.2s;
          position: relative;
        }

        .zona-drop.drag-over {
          background: #bbdefb;
        }

        .carta-jugador.dragging {
          opacity: 0.5;
          border: 2px solid #1976d2;
          box-shadow: 0 0 16px #1976d2;
        }

        .zona-drop .remove-carta {
          position: absolute;
          top: 6px;
          right: 10px;
          background: #b71c1c;
          color: #fff;
          border: none;
          border-radius: 50%;
          width: 24px;
          height: 24px;
          font-size: 1.1em;
          cursor: pointer;
          z-index: 2;
          display: flex;
          align-items: center;
          justify-content: center;
        }
      </style>
    </section>
  </main>
  <script type="module" src="js/fantasy.js"></script>
  <script type="module">
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    // Firebase ya está inicializado en el script de abajo
    const auth = getAuth();

    // Comprobar si el usuario está logueado
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Usuario logueado
        document.getElementById('bienvenida').style.display = '';
        document.getElementById('fantasy-section').style.display = '';
        document.getElementById('login-requerido').style.display = 'none';
        document.getElementById('nombre-usuario').textContent = user.displayName || user.email;
      } else {
        // No logueado
        document.getElementById('bienvenida').style.display = 'none';
        document.getElementById('fantasy-section').style.display = 'none';
        document.getElementById('login-requerido').style.display = '';
      }
    });

    // Logout con Firebase
    document.getElementById('logout-btn').onclick = async () => {
      await signOut(auth);
      window.location.href = 'login.html';
    };

    // Ir al index
    document.getElementById('ir-index-btn').onclick = () => {
      window.location.href = 'index.html';
    };

    // Eliminar usuario con doble confirmación
    const eliminarBtn = document.getElementById('eliminar-usuario-btn');
    const confirmacionDiv = document.getElementById('confirmacion-eliminar');
    const confirmarEliminarBtn = document.getElementById('confirmar-eliminar-btn');
    const cancelarEliminarBtn = document.getElementById('cancelar-eliminar-btn');

    eliminarBtn.onclick = () => {
      confirmacionDiv.style.display = 'block';
    };
    cancelarEliminarBtn.onclick = () => {
      confirmacionDiv.style.display = 'none';
    };
    confirmarEliminarBtn.onclick = async () => {
      try {
        // Eliminar datos del usuario en Firestore antes de eliminar la cuenta
        const { getFirestore, doc, getDoc, setDoc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js');
        const db = getFirestore();
        const user = auth.currentUser;
        if (user) {
          // Recuperar plantilla antes de eliminar
          const userDoc = await getDoc(doc(db, 'usuarios', user.uid));
          let plantilla = [];
          if (userDoc.exists()) {
            plantilla = userDoc.data().plantilla || [];
          }
          // Recuperar mercado
          const mercadoDoc = await getDoc(doc(db, 'mercado', 'global'));
          let mercado = {};
          if (mercadoDoc.exists()) {
            mercado = mercadoDoc.data().mercado || {};
          }
          // Devolver jugadores al mercado con valor al 80% y etiqueta
          plantilla.forEach(jugador => {
            mercado[jugador] = null;
            // Guardar info de "devuelto80" en notificaciones del mercado
            // Se marca en Firestore para que fantasy.js lo muestre
            if (!mercado._devueltos) mercado._devueltos = {};
            mercado._devueltos[jugador] = true;
          });
          await setDoc(doc(db, 'mercado', 'global'), { mercado }, { merge: true });
          // Eliminar documento de usuario
          await deleteDoc(doc(db, 'usuarios', user.uid));
        }
        await auth.currentUser.delete();
        window.location.href = 'login.html';
      } catch (e) {
        alert('Debes volver a iniciar sesión para eliminar tu usuario por seguridad.');
        await signOut(auth);
        window.location.href = 'login.html';
      }
    };
  </script>
</body>